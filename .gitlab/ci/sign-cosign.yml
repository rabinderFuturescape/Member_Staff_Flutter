cosign-sign:
  image: golang:1.21
  stage: sign
  before_script:
    - apt-get update && apt-get install -y curl
    - curl -sSLo cosign https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
    - chmod +x cosign && mv cosign /usr/local/bin/
  script:
    - echo "$COSIGN_PRIVATE_KEY" > cosign.key
    - cosign sign --key cosign.key $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
  after_script:
    - rm -f cosign.key
  only:
    - main
    - feature/cosign
  needs:
    - dockerize

cosign-verify:
  image: golang:1.21
  stage: verify
  before_script:
    - apt-get update && apt-get install -y curl
    - curl -sSLo cosign https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64
    - chmod +x cosign && mv cosign /usr/local/bin/
  script:
    - echo "$COSIGN_PUBLIC_KEY" > cosign.pub
    - cosign verify --key cosign.pub $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
  after_script:
    - rm -f cosign.pub
  only:
    - main
    - feature/cosign
  needs:
    - cosign-sign
